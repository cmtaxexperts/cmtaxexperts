<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#b91c1c">
<link rel="apple-touch-icon" href="logocmbooks.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>cmBOOKS - Corporate Dashboard</title>
    <link rel="icon" type="image/png" href="logocmbooks.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        /* --- CORPORATE THEME --- */
        :root {
            --brand-red: #b91c1c;       
            --bg-body: #f3f4f6;         
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: #334155; }
        
        /* Components */
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--brand-red); cursor: pointer; }
        
        .btn-primary { background-color: var(--brand-red); color: white; font-weight: 600; border-radius: 8px; padding: 0.5rem 1rem; }
        .btn-primary:hover { background-color: #991b1b; }
        
        .badge { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-red { background: #fef2f2; color: #dc2626; }
        .badge-green { background: #ecfdf5; color: #059669; }
        
        .filter-input { width: 100%; padding: 4px 8px; font-size: 11px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; outline: none; }
        .filter-input:focus { border-color: var(--brand-red); background: white; }
        
        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { color: var(--brand-red); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: var(--brand-red); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 z-50 shrink-0 shadow-sm">
        <div class="flex items-center gap-3 w-full max-w-5xl mx-auto">
            <div class="flex items-center gap-2 cursor-pointer shrink-0" onclick="app.nav('dashboard')">
                <img src="logocmbooks.png" class="w-8 h-8 object-contain">
                <span class="text-xl hidden md:block tracking-tight">
                    <span class="text-gray-400 font-medium">cm</span><span class="text-red-700 font-bold">BOOKS</span>
                </span>
            </div>

            <div class="relative flex-grow mx-4">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                <input type="text" id="global-search" 
                    class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-all"
                    placeholder="Search Client ID, Name, Mobile, Email..."
                    onkeyup="app.handleGlobalSearch(this.value)">
                <div id="search-results" class="absolute top-12 left-0 w-full bg-white rounded-xl shadow-xl border border-gray-100 hidden max-h-80 overflow-y-auto z-50"></div>
            </div>

            <button onclick="location.reload()" class="text-gray-400 hover:text-red-700 transition"><i class="fas fa-sync-alt"></i></button>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto relative p-4 hide-scrollbar">
        <div class="max-w-5xl mx-auto space-y-6 pb-20">

            <div id="view-dashboard" class="fade-in space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-5 border-l-4 border-green-500">
                        <div class="flex justify-between items-start mb-2"><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Receivables</p></div><div class="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center text-green-600"><i class="fas fa-arrow-down"></i></div></div>
                        <h2 class="text-2xl font-bold text-slate-800" id="dash-receivable">₹ 0.00</h2>
                    </div>
                    <div class="card p-5 border-l-4 border-red-500">
                        <div class="flex justify-between items-start mb-2"><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Payables</p></div><div class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-600"><i class="fas fa-arrow-up"></i></div></div>
                        <h2 class="text-2xl font-bold text-slate-800" id="dash-payable">₹ 0.00</h2>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-5 flex flex-col items-center justify-center text-center border-t-4 border-red-600">
                        <h3 class="text-4xl font-bold text-red-600 mb-1" id="comp-pending-count">0</h3>
                        <p class="text-xs font-bold text-gray-500 uppercase">Pending Tasks</p>
                    </div>
                    <div class="card md:col-span-2 p-4">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                            <h3 class="font-bold text-slate-700 text-sm">Upcoming Compliances</h3>
                            <span class="text-xs text-blue-600 font-bold"><i class="fas fa-calendar-alt mr-1"></i> Calendar</span>
                        </div>
                        <div id="comp-upcoming-list" class="space-y-2 max-h-40 overflow-y-auto hide-scrollbar"><div class="text-center text-xs text-gray-400 py-4">Loading...</div></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 md:grid-cols-6 gap-3 pt-4 border-t border-gray-200">
                    <button onclick="app.nav('clients')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-users text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">Clients</span></button>
                    <button onclick="app.nav('invoices')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-file-invoice text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">Invoices</span></button>
                    <button onclick="app.nav('accounts')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-calculator text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">Accounts</span></button>
                    <button onclick="app.nav('compliance')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-clipboard-check text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">Tasks</span></button>
                    <button onclick="app.nav('credentials')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-key text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">Logins</span></button>
                    <button onclick="app.nav('daybook')" class="card card-hover p-4 flex flex-col items-center gap-2 group"><i class="fas fa-book text-2xl text-gray-400 group-hover:text-red-700"></i><span class="text-[10px] font-bold text-gray-600 uppercase">DayBook</span></button>
                </div>
            </div>

            <div id="view-module" class="hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="app.nav('dashboard')" class="text-xs font-bold text-gray-500 hover:text-red-700 flex items-center"><i class="fas fa-arrow-left mr-1"></i> Dashboard</button>
                    <h2 class="text-lg font-bold text-slate-800" id="module-title">Module</h2>
                    <button id="module-add-btn" class="btn-primary text-xs">+ Add New</button>
                </div>

                <div id="invoice-options" class="hidden grid grid-cols-2 gap-4 mb-4">
                    <a href="https://docs.google.com/spreadsheets/d/1ZvjCfys0_XAcfM339HfB5_9X8TpBzt_3eP3dKzdLIMc/edit#gid=897038703" target="_blank" class="card card-hover p-4 flex items-center justify-center gap-2 text-red-700 font-bold"><i class="fas fa-plus-circle"></i> Create Invoice (Sheet)</a>
                    <div class="card p-4 flex items-center justify-center gap-2 text-gray-400 font-bold bg-gray-50"><i class="fas fa-list"></i> Statement View (Below)</div>
                </div>

                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="main-table">
                            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b border-gray-100">
                                <tr id="table-headers"></tr>
                                <tr id="table-filters" class="bg-white border-b border-gray-100"></tr>
                            </thead>
                            <tbody id="table-body" class="text-sm text-slate-700 divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-client-detail" class="hidden fade-in">
                <button onclick="app.nav('dashboard')" class="mb-4 text-xs font-bold text-gray-500 hover:text-red-700 flex items-center"><i class="fas fa-arrow-left mr-1"></i> Back to Dashboard</button>
                <div class="card p-6 mb-6 border-l-4 border-red-700 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-user-circle text-8xl"></i></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <div><h1 class="text-2xl font-bold text-slate-800" id="cd-name">Name</h1><p class="text-sm text-red-600 font-mono font-bold" id="cd-id">ID</p></div>
                            <span class="badge badge-green" id="cd-branch">Branch</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 text-sm">
                            <div><p class="text-xs text-gray-400 uppercase">Mobile</p><p class="font-semibold" id="cd-mobile">-</p></div>
                            <div><p class="text-xs text-gray-400 uppercase">Email</p><p class="font-semibold" id="cd-email">-</p></div>
                            <div><p class="text-xs text-gray-400 uppercase">GSTIN</p><p class="font-semibold" id="cd-gst">-</p></div>
                            <div><p class="text-xs text-gray-400 uppercase">PAN</p><p class="font-semibold" id="cd-pan">-</p></div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex gap-3">
                            <a id="cd-drive" href="#" target="_blank" class="text-xs font-bold text-blue-600 flex items-center"><i class="fab fa-google-drive mr-1"></i> Drive</a>
                            <a id="cd-whatsapp" href="#" target="_blank" class="text-xs font-bold text-green-600 flex items-center"><i class="fab fa-whatsapp mr-1"></i> WhatsApp</a>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4"><h3 class="font-bold text-slate-700 text-sm mb-3 border-b pb-2">Pending Compliances</h3><div id="cd-comp-list" class="space-y-2 text-sm"></div></div>
                    <div class="card p-4"><h3 class="font-bold text-slate-700 text-sm mb-3 border-b pb-2">Recent Invoices</h3><div id="cd-inv-list" class="space-y-2 text-sm"></div></div>
                </div>
            </div>

        </div>
    </main>

    <div id="modal-client" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between"><h3 class="font-bold">Add Client</h3><button onclick="closeModal('client')"><i class="fas fa-times"></i></button></div>
            <form id="form-client" class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="c-rowIndex">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Client ID</label><input type="text" id="Client_ID" name="Client_ID" class="w-full p-2 bg-red-50 border rounded text-xs font-mono font-bold text-red-700" readonly></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-gray-500 uppercase">Client Name *</label><input type="text" id="Client_Name" name="Client_Name" class="w-full p-2 border rounded text-xs font-bold" required></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Branch</label><select id="Branch" name="Branch" class="w-full p-2 border rounded text-xs"><option value="CMTE">CMTE</option><option value="ACT">ACT</option><option value="CMbooks">CMbooks</option></select></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Constitution</label><select id="Constitution" name="Constitution" class="w-full p-2 border rounded text-xs"><option value="Individual">Individual</option><option value="Proprietorship">Proprietorship</option><option value="Partnership">Partnership</option><option value="LLP">LLP</option><option value="Private Limited">Pvt Ltd</option></select></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-gray-500 uppercase">Reference</label><input type="text" id="Reference" name="Reference" class="w-full p-2 border rounded text-xs"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Mobile</label><input type="tel" id="Mobile_No" name="Mobile_No" class="w-full p-2 border rounded text-xs"></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Email</label><input type="email" id="Email" name="Email" class="w-full p-2 border rounded text-xs"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">DOB / DOC</label><input type="date" id="DOB" name="DOB" class="w-full p-2 border rounded text-xs"></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Aadhaar No</label><input type="text" id="Adhar_No" name="Adhar_No" class="w-full p-2 border rounded text-xs"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">GSTIN</label><input type="text" id="GST_No" name="GST_No" class="w-full p-2 border rounded text-xs uppercase"></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">PAN</label><input type="text" id="Pan_No" name="Pan_No" class="w-full p-2 border rounded text-xs uppercase"></div>
                </div>
                <div class="border-t pt-2 mt-2">
                    <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block">Address Details</label>
                    <div class="grid grid-cols-2 gap-2 mb-2"><input type="text" id="addr_bldg" placeholder="Building" class="p-2 border rounded text-xs"><input type="text" id="addr_area" placeholder="Area" class="p-2 border rounded text-xs"></div>
                    <div class="grid grid-cols-3 gap-2"><input type="text" id="addr_dist" placeholder="District" class="p-2 border rounded text-xs"><input type="text" id="addr_state" placeholder="State" class="p-2 border rounded text-xs"><input type="text" id="addr_pin" placeholder="Pincode" class="p-2 border rounded text-xs"></div>
                    <input type="hidden" id="Address" name="Address">
                </div>
                <div><label class="text-[10px] font-bold text-gray-500 uppercase">Folder Link</label><input type="url" id="Folder_Link" name="Folder_Link" class="w-full p-2 border rounded text-xs text-blue-600"></div>
                <button type="submit" class="w-full py-3 btn-primary rounded-xl text-sm">Save Client</button>
            </form>
        </div>
    </div>

    <div id="modal-generic" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between"><h3 class="font-bold" id="gen-title">Entry</h3><button onclick="closeModal('generic')"><i class="fas fa-times"></i></button></div>
            <form id="form-generic" class="p-5 overflow-y-auto space-y-3">
                <input type="hidden" id="g-action">
                <div><label class="text-[10px] font-bold uppercase text-gray-500">Client</label><select id="g-client" class="w-full p-2 border rounded text-xs" onchange="setClientName()"><option value="">Select...</option></select><input type="hidden" id="g-client-name"></div>
                <div id="f-creds" class="hidden space-y-3"><input type="text" id="Portal_Name" name="Portal_Name" placeholder="Portal Name" class="w-full p-2 border rounded text-xs"><input type="text" id="User_ID" name="User_ID" placeholder="User ID" class="w-full p-2 border rounded text-xs"><input type="text" id="Password" name="Password" placeholder="Password" class="w-full p-2 border rounded text-xs"><input type="text" id="Notes" name="Notes" placeholder="Last Changed / Notes" class="w-full p-2 border rounded text-xs"></div>
                <div id="f-comp" class="hidden space-y-3"><input type="text" id="Service_Description" name="Service_Description" placeholder="Service Name" class="w-full p-2 border rounded text-xs"><input type="date" id="Due_Date" name="Due_Date" class="w-full p-2 border rounded text-xs"><select id="Status" name="Status" class="w-full p-2 border rounded text-xs"><option value="Pending">Pending</option><option value="Done">Done</option></select></div>
                <div id="f-money" class="hidden space-y-3"><input type="date" id="g-Date" name="Date" class="w-full p-2 border rounded text-xs"><input type="text" id="Description" name="Description" placeholder="Description" class="w-full p-2 border rounded text-xs"><div class="grid grid-cols-2 gap-2"><input type="number" id="Amount" name="Amount" placeholder="Amount" class="p-2 border rounded text-xs font-bold"><select id="Type" name="Type" class="p-2 border rounded text-xs"><option value="Income">Income (In)</option><option value="Expense">Expense (Out)</option></select></div><select id="Mode" name="Mode" class="w-full p-2 border rounded text-xs"><option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Bank">Bank</option></select></div>
                <button type="submit" id="g-save-btn" class="w-full py-3 btn-primary rounded-xl text-sm">Save</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwT6x4UwIfAX4ZO3zVTjGY3cY81mF5qTfunKI1rCDFGVjdJcVDMTePiFNKTsl2ukTzI/exec";
        const store = { clients: [], invoices: [], compliance: [], accounts: [], credentials: [], daybook: [] };

        // Helper: Currency & Date
        const fmtMoney = (n) => "₹ " + Number(n).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const fmtDate = (d) => d ? moment(d).format('DD-MM-YYYY') : '-';

        const app = {
            init: async () => {
                document.getElementById('comp-upcoming-list').innerHTML = '<div class="loader mx-auto"></div>';
                try {
                    store.clients = (await (await fetch(API_URL + "?type=clients")).json()).data;
                    store.invoices = (await (await fetch(API_URL + "?type=invoices")).json()).data;
                    store.compliance = (await (await fetch(API_URL + "?type=compliance")).json()).data;
                    store.accounts = (await (await fetch(API_URL + "?type=accounts")).json()).data;
                    store.credentials = (await (await fetch(API_URL + "?type=credentials")).json()).data;
                    store.daybook = (await (await fetch(API_URL + "?type=daybook")).json()).data;
                    app.renderDashboard();
                } catch(e) { console.error("Init Failed", e); }
            },

            renderDashboard: () => {
                const unpaid = store.invoices.filter(i => i.Payment_Status !== 'Paid');
                document.getElementById('dash-receivable').innerText = fmtMoney(unpaid.reduce((sum, i) => sum + Number(i.Amount || 0), 0));
                const totalExpense = store.accounts.reduce((sum, a) => (a.Txn_Type === 'Expense') ? sum + Number(a.Amount || 0) : sum, 0);
                document.getElementById('dash-payable').innerText = fmtMoney(totalExpense);
                const pending = store.compliance.filter(c => c.Status !== 'Done');
                document.getElementById('comp-pending-count').innerText = pending.length;
                const listEl = document.getElementById('comp-upcoming-list');
                listEl.innerHTML = "";
                const sortedComp = [...pending].sort((a,b) => new Date(a.Due_Date) - new Date(b.Due_Date));
                if(sortedComp.length === 0) listEl.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">No pending tasks</p>';
                else sortedComp.slice(0, 5).forEach(c => {
                    const isOverdue = new Date(c.Due_Date) < new Date();
                    // CORRECTION [1]: ID below Name
                    listEl.innerHTML += `<div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded border-b border-gray-50 last:border-0">
                        <div><p class="text-xs font-bold text-slate-700">${c.Client_Name}</p><p class="text-[9px] text-gray-400 font-normal">${c.Client_ID||''}</p><p class="text-[10px] text-gray-400 mt-0.5">${c.Service_Description}</p></div>
                        <span class="text-[10px] ${isOverdue ? 'text-red-600 font-bold' : 'text-gray-500'}">${fmtDate(c.Due_Date)}</span>
                    </div>`;
                });
            },

            handleGlobalSearch: (q) => {
                const res = document.getElementById('search-results');
                if(q.length < 2) { res.classList.add('hidden'); return; }
                const matches = store.clients.filter(c => (c.Client_Name && c.Client_Name.toLowerCase().includes(q.toLowerCase())) || (c.Client_ID && c.Client_ID.toLowerCase().includes(q.toLowerCase()))).slice(0, 5);
                res.innerHTML = "";
                matches.forEach(c => res.innerHTML += `<div onclick='app.openClientDetail(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between items-center"><div><p class="text-sm font-bold text-slate-800">${c.Client_Name}</p><p class="text-xs text-gray-400">${c.Client_ID}</p></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>`);
                if(matches.length > 0) res.classList.remove('hidden');
            },

            openClientDetail: (c) => {
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-module').classList.add('hidden');
                document.getElementById('view-client-detail').classList.remove('hidden');
                document.getElementById('cd-name').innerText = c.Client_Name;
                document.getElementById('cd-id').innerText = c.Client_ID;
                document.getElementById('cd-branch').innerText = c.Branch || '-';
                document.getElementById('cd-mobile').innerText = c.Mobile_No || '-';
                document.getElementById('cd-email').innerText = c.Email || '-';
                document.getElementById('cd-gst').innerText = c.GST_No || '-';
                document.getElementById('cd-pan').innerText = c.Pan_No || '-';
                document.getElementById('cd-drive').href = c.Folder_Link || '#';
                document.getElementById('cd-whatsapp').href = `https://wa.me/91${c.Mobile_No}`;
                const compList = document.getElementById('cd-comp-list'); compList.innerHTML = "";
                const clientComp = store.compliance.filter(x => x.Client_ID === c.Client_ID);
                clientComp.forEach(t => compList.innerHTML += `<div class="flex justify-between border-b border-gray-50 py-2"><span class="text-xs text-gray-600">${t.Service_Description}</span><span class="badge ${t.Status==='Done'?'badge-green':'badge-red'}">${t.Status}</span></div>`);
                const invList = document.getElementById('cd-inv-list'); invList.innerHTML = "";
                const clientInv = store.invoices.filter(x => x.Client_ID === c.Client_ID);
                clientInv.forEach(i => invList.innerHTML += `<div class="flex justify-between border-b border-gray-50 py-2"><div><p class="text-xs font-bold">${i.Invoice_No}</p><p class="text-[10px] text-gray-400">${fmtDate(i.Invoice_Date)}</p></div><div class="text-right"><p class="text-xs font-bold">${fmtMoney(i.Amount)}</p><p class="text-[10px] ${i.Payment_Status==='Paid'?'text-green-600':'text-red-600'}">${i.Payment_Status||'Unpaid'}</p></div></div>`);
            },

            nav: (view) => {
                document.getElementById('view-client-detail').classList.add('hidden');
                if(view === 'dashboard') {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    document.getElementById('view-module').classList.add('hidden');
                } else {
                    document.getElementById('view-dashboard').classList.add('hidden');
                    document.getElementById('view-module').classList.remove('hidden');
                    document.getElementById('module-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
                    document.getElementById('invoice-options').classList.toggle('hidden', view !== 'invoices');
                    renderModuleTable(view);
                    const btn = document.getElementById('module-add-btn');
                    if(view === 'clients') btn.onclick = () => clients.openModal('add');
                    else if(view === 'credentials') btn.onclick = () => openGenericModal('creds');
                    else if(view === 'compliance') btn.onclick = () => openGenericModal('comp');
                    else if(view === 'accounts') btn.onclick = () => openGenericModal('accounts');
                    else if(view === 'daybook') btn.onclick = () => openGenericModal('daybook');
                    else btn.onclick = null;
                }
            },

            sortTable: (n) => {
                var table = document.getElementById("main-table"), rows, switching = true, i, x, y, shouldSwitch, dir = "asc", switchcount = 0;
                document.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas fa-sort ml-1 text-gray-300 sort-icon');
                while (switching) {
                    switching = false; rows = table.rows;
                    for (i = 2; i < (rows.length - 1); i++) {
                        shouldSwitch = false;
                        x = rows[i].getElementsByTagName("TD")[n]; y = rows[i + 1].getElementsByTagName("TD")[n];
                        if (!x || !y) continue;
                        let xVal = x.innerText.toLowerCase().replace(/[^\d.-]/g, ''), yVal = y.innerText.toLowerCase().replace(/[^\d.-]/g, '');
                        if(x.innerText.includes('₹') || !isNaN(Date.parse(x.innerText))) { /* Handle number/date */ } else { xVal = x.innerText.toLowerCase(); yVal = y.innerText.toLowerCase(); }
                        if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } } else if (dir == "desc") { if (xVal < yVal) { shouldSwitch = true; break; } }
                    }
                    if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount ++; } else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } }
                }
                table.rows[0].getElementsByTagName("TH")[n].getElementsByTagName("I")[0].className = `fas fa-sort-${dir === 'asc' ? 'up' : 'down'} ml-1 text-red-600 sort-icon`;
            }
        };

        function renderModuleTable(view) {
            const th = document.getElementById('table-headers'), tf = document.getElementById('table-filters'), tb = document.getElementById('table-body');
            th.innerHTML = ""; tf.innerHTML = ""; tb.innerHTML = "";
            let headers = [], data = [];
            if(view === 'clients') { headers = ['ID', 'Name', 'Mobile', 'GST']; data = store.clients; }
            else if(view === 'accounts') { headers = ['Date', 'Particulars', 'Amount', 'Type']; data = store.accounts; }
            else if(view === 'invoices') { headers = ['Inv No', 'Date', 'Client', 'Amount']; data = store.invoices; }
            else if(view === 'compliance') { headers = ['Client', 'Service', 'Due Date', 'Status', 'Actions']; data = store.compliance; }
            else if(view === 'credentials') { headers = ['Client', 'Portal', 'User ID', 'Password', 'Changed', 'Link']; data = store.credentials; }
            else if(view === 'daybook') { headers = ['Date', 'Description', 'Amount', 'Mode']; data = store.daybook; }

            headers.forEach((h, idx) => {
                th.innerHTML += `<th class="p-3 border-b sort-header" onclick="app.sortTable(${idx})">${h}<i class="fas fa-sort ml-1 text-gray-300 sort-icon"></i></th>`;
                tf.innerHTML += `<th class="p-1 border-b"><input type="text" class="filter-input" placeholder="Filter..." onkeyup="filterTable(${idx}, this.value)"></th>`;
            });

            if(data.length === 0) tb.innerHTML = `<tr><td colspan="${headers.length}" class="p-4 text-center text-gray-400 text-xs">No records</td></tr>`;
            else data.reverse().forEach(row => {
                let html = `<tr class="border-b hover:bg-gray-50 align-top">`;
                // CORRECTION [1]: ID below Name Logic in Tables
                if(view === 'clients') html += `<td class="p-3 text-red-700 font-bold text-xs">${row.Client_ID}</td><td class="p-3 font-bold text-xs">${row.Client_Name}</td><td class="p-3 text-xs">${row.Mobile_No}</td><td class="p-3 text-xs font-mono">${row.GST_No||'-'}</td>`;
                else if(view === 'accounts') html += `<td class="p-3 text-xs">${fmtDate(row.Date)}</td><td class="p-3 text-xs font-bold"><div>${row.Particulars}</div><div class="text-[9px] text-gray-400 font-normal mt-0.5">${row.Client_Name ? row.Client_Name + ' ('+(row.Client_ID||'')+')' : ''}</div></td><td class="p-3 text-xs font-bold text-right">${fmtMoney(row.Amount)}</td><td class="p-3 text-xs text-center">${row.Txn_Type}</td>`;
                else if(view === 'invoices') html += `<td class="p-3 text-xs font-mono text-red-700">${row.Invoice_No}</td><td class="p-3 text-xs">${fmtDate(row.Invoice_Date)}</td><td class="p-3 text-xs font-bold"><div>${row.Client_Name}</div><div class="text-[9px] text-gray-400 font-normal mt-0.5">${row.Client_ID||''}</div></td><td class="p-3 text-xs text-right font-bold">${fmtMoney(row.Amount)}</td>`;
                else if(view === 'compliance') {
                    const client = store.clients.find(c => c.Client_Name === row.Client_Name) || {};
                    const mob = client.Mobile_No || ''; const em = client.Email || '';
                    const msg = encodeURIComponent(`Dear ${row.Client_Name}, your compliance ${row.Service_Description} due on ${fmtDate(row.Due_Date)} is pending.`);
                    
                    html += `<td class="p-3 text-xs font-bold"><div>${row.Client_Name}</div><div class="text-[9px] text-gray-400 font-normal mt-0.5">${row.Client_ID||''}</div></td><td class="p-3 text-xs">${row.Service_Description}</td><td class="p-3 text-xs">${fmtDate(row.Due_Date)}</td><td class="p-3 text-xs"><span class="badge ${row.Status==='Done'?'badge-green':'badge-red'}">${row.Status}</span></td>
                    <td class="p-3 text-xs flex gap-2">
                        ${mob ? `<a href="https://wa.me/91${mob}?text=${msg}" target="_blank" class="text-green-600 hover:scale-110"><i class="fab fa-whatsapp text-lg"></i></a>` : ''}
                        ${em ? `<a href="mailto:${em}?subject=Compliance Due&body=${msg}" class="text-blue-600 hover:scale-110"><i class="fas fa-envelope text-lg"></i></a>` : ''}
                        ${mob ? `<a href="tel:${mob}" class="text-gray-500 hover:scale-110"><i class="fas fa-phone text-lg"></i></a>` : ''}
                    </td>`;
                }
                else if(view === 'credentials') html += `<td class="p-3 text-xs font-bold"><div>${row.Client_Name}</div><div class="text-[9px] text-gray-400 font-normal mt-0.5">${row.Client_ID||''}</div></td><td class="p-3 text-xs text-blue-600">${row.Portal_Name}</td><td class="p-3 text-xs font-mono">${row.User_ID}</td><td class="p-3 text-xs font-mono bg-yellow-50">${row.Password||'***'}</td><td class="p-3 text-xs text-gray-400">${row.Notes||'-'}</td><td class="p-3 text-xs text-blue-600 cursor-pointer" onclick="window.open('${row.Link}')">Link</td>`;
                else if(view === 'daybook') html += `<td class="p-3 text-xs">${fmtDate(row.Date)}</td><td class="p-3 text-xs font-bold"><div>${row.Description}</div><div class="text-[9px] text-gray-400 font-normal mt-0.5">${row.Client_Name||''}</div></td><td class="p-3 text-xs text-right font-bold ${row.Type==='Income'?'text-green-600':'text-red-600'}">${fmtMoney(row.Amount)}</td><td class="p-3 text-xs">${row.Mode}</td>`;
                html += `</tr>`;
                tb.innerHTML += html;
            });
        }

        function filterTable(colIndex, query) {
            const filter = query.toUpperCase(), table = document.getElementById("main-table"), tr = table.getElementsByTagName("tr");
            for (let i = 2; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[colIndex];
                if (td) tr[i].style.display = (td.textContent || td.innerText).toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        function closeModal(id) { document.getElementById('modal-'+id).classList.add('hidden'); }
        const clients = { openModal: (mode) => { document.getElementById('form-client').reset(); document.getElementById('modal-client').classList.remove('hidden'); if(mode==='add') { let maxId = 40000; if(store.clients.length > 0 && store.clients[0].Client_ID.startsWith('C')) maxId = parseInt(store.clients[0].Client_ID.substring(1)); document.getElementById('Client_ID').value = "C" + (maxId + 1); } } };
        function openGenericModal(type) { const m = document.getElementById('modal-generic'), f = document.getElementById('form-generic'); f.reset(); ['creds', 'comp', 'money'].forEach(x => document.getElementById('f-'+x).classList.add('hidden')); if(type === 'creds') { document.getElementById('gen-title').innerText = "New Credential"; document.getElementById('g-action').value = "addCredential"; document.getElementById('f-creds').classList.remove('hidden'); } else if (type === 'comp') { document.getElementById('gen-title').innerText = "New Compliance"; document.getElementById('g-action').value = "addCompliance"; document.getElementById('f-comp').classList.remove('hidden'); } else if (type === 'daybook' || type === 'accounts') { document.getElementById('gen-title').innerText = type === 'daybook' ? "Day Book Entry" : "Account Entry"; document.getElementById('g-action').value = type === 'daybook' ? "addDayBook" : "addTransaction"; document.getElementById('f-money').classList.remove('hidden'); document.getElementById('g-Date').valueAsDate = new Date(); if(type === 'accounts') { document.getElementById('Description').name = "Particulars"; document.getElementById('Type').name = "Txn_Type"; } else { document.getElementById('Description').name = "Description"; document.getElementById('Type').name = "Type"; } } const sel = document.getElementById('g-client'); sel.innerHTML = '<option value="">Select Client...</option>'; store.clients.forEach(c => sel.innerHTML += `<option value="${c.Client_ID}">${c.Client_Name}</option>`); m.classList.remove('hidden'); }
        function setClientName() { const sel = document.getElementById('g-client'); document.getElementById('g-client-name').value = sel.options[sel.selectedIndex].text; }
        document.getElementById('form-generic').addEventListener('submit', async (e) => { e.preventDefault(); const btn = document.getElementById('g-save-btn'); btn.innerHTML = 'Saving...'; btn.disabled = true; const obj = Object.fromEntries(new FormData(e.target).entries()); obj.action = document.getElementById('g-action').value; obj.Client_ID = document.getElementById('g-client').value; obj.Client_Name = document.getElementById('g-client-name').value; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(obj) }); closeModal('generic'); location.reload(); } catch(err) { alert('Error'); } finally { btn.innerHTML = 'Save'; btn.disabled = false; } });
        document.getElementById('form-client').addEventListener('submit', async (e) => { e.preventDefault(); const addr = [document.getElementById('addr_bldg').value, document.getElementById('addr_area').value, document.getElementById('addr_dist').value, document.getElementById('addr_state').value, document.getElementById('addr_pin').value].filter(Boolean).join(', '); document.getElementById('Address').value = addr; const obj = Object.fromEntries(new FormData(e.target).entries()); obj.action = "addClient"; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(obj) }); closeModal('client'); location.reload(); } catch(err) { alert('Error'); } });
        window.addEventListener('DOMContentLoaded', app.init); document.addEventListener('click', (e) => { if(!e.target.closest('#global-search')) document.getElementById('search-results').classList.add('hidden'); });
    </script>
</body>
</html>
