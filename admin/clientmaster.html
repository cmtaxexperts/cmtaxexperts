<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Master - CM Tax Experts</title>
    <link rel="icon" type="image/png" href="https://cmtaxexperts.com/LOGOFAVICON.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #b91c1c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-group label { font-size: 0.75rem; font-weight: 700; color: #4b5563; margin-bottom: 2px; display: block; }
        .form-input { width: 100%; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: #b91c1c; ring: 1px solid #b91c1c; }
        /* Table Row Hover Animation */
        tbody tr { transition: background-color 0.2s; }
        tbody tr:hover { background-color: #fff1f2; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans text-slate-800">

    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="https://cmtaxexperts.com/LOGOWEBSITE.png" alt="Logo" class="h-10 w-10 rounded mr-3">
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">CM Tax Experts</h1>
                        <p class="text-xs text-red-700 font-bold uppercase">Client Master</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="openModal('add')" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center shadow-md transition">
                        <i class="fas fa-plus mr-2"></i> Add Client
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-[98%] mx-auto py-6 w-full">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center">
            <div class="relative w-full md:w-96">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search Name, ID, PAN, GST..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg w-full focus:outline-none focus:border-red-500 transition">
            </div>
            <div class="text-sm text-gray-500 font-medium bg-gray-100 px-3 py-1 rounded-full" id="recordCount">Loading database...</div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto max-h-[80vh]"> <table class="min-w-full divide-y divide-gray-200 relative">
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Client Details</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Branch</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tax IDs</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Drive</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Edit</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="7" class="px-6 py-10 text-center"><div class="flex justify-center"><div class="loader"></div></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="clientModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl m-4 my-8 relative">
            
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Add New Client</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <form id="clientForm" class="p-6">
                <input type="hidden" id="rowIndex"> <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="Client_ID" name="Client_ID" class="form-input bg-gray-100 font-mono font-bold text-red-700" readonly>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label>Client Name <span class="text-red-500">*</span></label>
                        <input type="text" id="Client_Name" name="Client_Name" class="form-input" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label>Branch</label>
                        <select id="Branch" name="Branch" class="form-input">
                            <option value="CMTE">CMTE</option>
                            <option value="ACT">ACT</option>
                            <option value="CMbooks">CMbooks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Reference</label>
                        <input type="text" id="Reference" name="Reference" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Constitution</label>
                        <select id="Constitution" name="Constitution" class="form-input">
                            <option value="Individual">Individual</option>
                            <option value="Proprietorship">Proprietorship</option>
                            <option value="Partnership">Partnership</option>
                            <option value="LLP">LLP</option>
                            <option value="Private Limited">Private Limited</option>
                            <option value="Trust">Trust</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label>Legal / Trade Name</label>
                        <input type="text" id="Legal_Name" name="Legal_Name" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth / Incorp.</label>
                        <input type="date" id="DOB" name="DOB" class="form-input">
                    </div>
                </div>

                <div class="p-3 bg-red-50 rounded-lg border border-red-100 mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label>PAN Number</label>
                        <input type="text" id="Pan_No" name="Pan_No" class="form-input uppercase font-mono" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" placeholder="ABCDE1234F" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="form-group">
                        <label>Aadhaar Number</label>
                        <input type="text" id="Adhar_No" name="Adhar_No" class="form-input font-mono" pattern="\d{12}" placeholder="12 Digit Number">
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" id="GST_No" name="GST_No" class="form-input uppercase font-mono" oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label>Mobile No (+91)</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm font-bold">+91</span>
                            <input type="tel" id="Mobile_No" name="Mobile_No" class="form-input rounded-l-none" pattern="[0-9]{10}" placeholder="9876543210">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email ID</label>
                        <input type="email" id="Email" name="Email" class="form-input">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">Address Details</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <input type="text" id="addr_bldg" placeholder="Bldg No" class="form-input">
                        <input type="text" id="addr_name" placeholder="Building Name" class="form-input md:col-span-3">
                        <input type="text" id="addr_area" placeholder="Area" class="form-input md:col-span-2">
                        <input type="text" id="addr_po" placeholder="Post Office" class="form-input md:col-span-2">
                        <input type="text" id="addr_dist" placeholder="District" class="form-input md:col-span-2">
                        <input type="text" id="addr_state" placeholder="State" class="form-input">
                        <input type="text" id="addr_pin" placeholder="Pin Code" class="form-input">
                    </div>
                    <input type="hidden" id="Address" name="Address">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label>Google Drive Link</label>
                        <input type="url" id="Folder_Link" name="Folder_Link" class="form-input text-blue-600" placeholder="https://drive.google.com/...">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="Notes" name="Notes" class="form-input">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-semibold">Cancel</button>
                    <button type="submit" id="submitBtn" class="px-6 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition font-bold shadow-md flex items-center">
                        <i class="fas fa-save mr-2"></i> Save Client
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Your Verified Google App Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxtRmRQ2fp88ngftg6Q8yA8o_uWPHP3rMECcx6BSBZJbjYbZ9Gy1W-RDb8hHeMakfWA/exec"; 
        
        let allData = [];
        let nextClientId = "";

        // On Load
        document.addEventListener('DOMContentLoaded', fetchData);

        // Fetch Data
        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const json = await response.json();
                allData = json.data;
                nextClientId = json.nextId;
                renderTable(allData);
                document.getElementById('recordCount').innerText = `${allData.length} active clients`;
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Failed to load data.</td></tr>`;
            }
        }

        // Render Table
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">No records found</td></tr>`;
                return;
            }

            // Sort data by ID (Newest first)
            // Assuming IDs like C40001, sort descending
            // If strictly needed, otherwise skip sorting or sort by insertion
            data.reverse(); 

            data.forEach(client => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono font-bold text-red-700 align-top">${client.Client_ID || ''}</td>
                    <td class="px-4 py-3 align-top">
                        <div class="font-bold text-gray-900">${client.Client_Name}</div>
                        ${client.Legal_Name ? `<div class="text-xs text-gray-500">${client.Legal_Name}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 align-top"><span class="px-2 py-1 bg-gray-100 rounded text-xs font-bold text-gray-600">${client.Branch || '-'}</span></td>
                    <td class="px-4 py-3 text-gray-600 text-xs align-top">
                        ${client.Mobile_No ? `<div><i class="fas fa-phone mr-1 text-gray-400"></i> ${client.Mobile_No}</div>` : ''}
                        ${client.Email ? `<div><i class="fas fa-envelope mr-1 text-gray-400"></i> ${client.Email}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 text-xs font-mono align-top">
                        ${client.Pan_No ? `<div title="PAN" class="text-gray-700">P: ${client.Pan_No}</div>` : ''}
                        ${client.GST_No ? `<div title="GST" class="text-blue-700">G: ${client.GST_No}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 text-center align-top">
                        ${client.Folder_Link ? `<a href="${client.Folder_Link}" target="_blank" class="text-green-600 hover:text-green-800 text-xl"><i class="fab fa-google-drive"></i></a>` : '<span class="text-gray-300">-</span>'}
                    </td>
                    <td class="px-4 py-3 text-right align-top">
                        <button onclick='openEditModal(${JSON.stringify(client)})' class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Search
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(item => 
                (item.Client_Name && item.Client_Name.toLowerCase().includes(term)) ||
                (item.Client_ID && item.Client_ID.toLowerCase().includes(term)) ||
                (item.Pan_No && item.Pan_No.toLowerCase().includes(term)) ||
                (item.GST_No && item.GST_No.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        // Modal Functions
        function openModal(mode) {
            const modal = document.getElementById('clientModal');
            const form = document.getElementById('clientForm');
            form.reset();
            
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "Add New Client";
                document.getElementById('Client_ID').value = nextClientId;
                document.getElementById('rowIndex').value = "";
            }
            modal.classList.remove('hidden');
        }

        function openEditModal(client) {
            openModal('edit');
            document.getElementById('modalTitle').innerText = "Edit Client";
            document.getElementById('rowIndex').value = client.rowIndex;

            // Map fields
            const fields = ['Client_ID', 'Client_Name', 'Reference', 'Branch', 'Legal_Name', 'Constitution', 'Pan_No', 'Adhar_No', 'GST_No', 'Mobile_No', 'Email', 'Folder_Link', 'Notes'];
            fields.forEach(f => {
                if(document.getElementById(f)) document.getElementById(f).value = client[f] || '';
            });

            // Date
            if(client.DOB) {
                let d = new Date(client.DOB);
                if(!isNaN(d)) document.getElementById('DOB').value = d.toISOString().split('T')[0];
                else document.getElementById('DOB').value = client.DOB;
            }

            // Address Parsing
            if(client.Address) {
                const parts = client.Address.split(', ');
                if(parts[0]) document.getElementById('addr_bldg').value = parts[0];
                if(parts[1]) document.getElementById('addr_name').value = parts[1];
                if(parts[2]) document.getElementById('addr_area').value = parts[2];
                if(parts[3]) document.getElementById('addr_po').value = parts[3];
                if(parts[4]) document.getElementById('addr_dist').value = parts[4];
                
                const last = parts[parts.length-1];
                if(last && last.includes('-')) {
                    const sp = last.split(' - ');
                    document.getElementById('addr_state').value = sp[0];
                    document.getElementById('addr_pin').value = sp[1];
                } else if(last) {
                    document.getElementById('addr_state').value = last;
                }
            }
        }

        function closeModal() {
            document.getElementById('clientModal').classList.add('hidden');
        }

        // Submit Handler
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Saving...`;
            btn.disabled = true;

            // Combine Address
            const addrParts = [
                document.getElementById('addr_bldg').value,
                document.getElementById('addr_name').value,
                document.getElementById('addr_area').value,
                document.getElementById('addr_po').value,
                document.getElementById('addr_dist').value
            ].filter(Boolean).join(', ');
            
            const state = document.getElementById('addr_state').value;
            const pin = document.getElementById('addr_pin').value;
            const fullAddr = addrParts + (state ? `, ${state}` : '') + (pin ? ` - ${pin}` : '');
            
            document.getElementById('Address').value = fullAddr;

            // Payload
            const formData = new FormData(e.target);
            const dataObj = Object.fromEntries(formData.entries());
            const rowIndex = document.getElementById('rowIndex').value;
            dataObj.action = rowIndex ? "edit" : "add";
            if(rowIndex) dataObj.rowIndex = rowIndex;

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataObj)
                });
                closeModal();
                fetchData();
            } catch (error) {
                console.error(error);
                alert("Error saving data.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
